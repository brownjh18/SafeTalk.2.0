{% extends "base.html" %}

{% block title %}Create Subscription Plan - SafeTalk{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Create Subscription Plan</h1>
    <p class="page-subtitle">Set up a new subscription plan for your users</p>
</div>

<div class="dashboard-grid">
    <!-- Plan Creation Form Card -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3 class="card-title">Plan Details</h3>
            <div class="card-icon">üìã</div>
        </div>
        <div class="card-content">
            <form method="post" class="plan-form">
                {% csrf_token %}

                <div class="form-grid">
                    <div class="form-group">
                        <label for="id_name" class="form-label">Plan Name</label>
                        <input type="text" name="name" id="id_name" class="form-input" placeholder="e.g., premium_monthly" required>
                        <small>Internal identifier for the plan (lowercase, no spaces)</small>
                    </div>

                    <div class="form-group">
                        <label for="id_display_name" class="form-label">Display Name</label>
                        <input type="text" name="display_name" id="id_display_name" class="form-input" placeholder="e.g., Premium Monthly" required>
                        <small>User-friendly name shown to customers</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="id_description" class="form-label">Description</label>
                    <textarea name="description" id="id_description" class="form-input" rows="3" placeholder="Describe what this plan includes..." required></textarea>
                    <small>Brief description of the plan benefits</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Monthly Price</label>
                    <div class="price-input-group">
                        <span class="currency-symbol">$</span>
                        <input type="number" name="price_monthly" id="id_price_monthly" class="form-input price-input" placeholder="29.99" step="0.01" min="0" required>
                        <span class="price-period">/month</span>
                    </div>
                    <small>Set the monthly subscription price</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Plan Features</label>
                    <div class="features-builder">
                        <div class="features-input-group">
                            <input type="text" id="feature-input" class="form-input" placeholder="Add a feature...">
                            <button type="button" class="action-btn secondary" onclick="addFeature()">Add Feature</button>
                        </div>
                        <div id="features-list" class="features-list">
                            <!-- Features will be added here -->
                        </div>
                    </div>
                    <small>List the key features included in this plan</small>
                    <!-- Hidden inputs for features will be added here -->
                    <div id="features-hidden-inputs"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="action-btn">
                        <i>‚úÖ</i> Create Plan
                    </button>
                    <a href="{% url 'admin_plan_management' %}" class="action-btn secondary">
                        <i>‚¨ÖÔ∏è</i> Back to Plans
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Plan Preview Card -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3 class="card-title">Live Preview</h3>
            <div class="card-icon">üëÅÔ∏è</div>
        </div>
        <div class="card-content">
            <div class="plan-preview">
                <div class="plan-card">
                    <div class="plan-header">
                        <h4 id="preview-name">Premium Monthly</h4>
                        <div class="plan-price" id="preview-price">$29.99/month</div>
                    </div>
                    <div class="plan-description" id="preview-description">
                        Access to all premium features including unlimited sessions, priority support, and advanced analytics.
                    </div>
                    <ul class="plan-features" id="preview-features">
                        <li>Unlimited counseling sessions</li>
                        <li>24/7 priority support</li>
                        <li>Advanced mood analytics</li>
                        <li>Custom report generation</li>
                    </ul>
                    <div class="plan-status">
                        <span class="status-badge status-active">Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Tips Card -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3 class="card-title">Quick Tips</h3>
            <div class="card-icon">üí°</div>
        </div>
        <div class="card-content">
            <div class="tips-list">
                <div class="tip-item">
                    <div class="tip-icon">üéØ</div>
                    <div class="tip-content">
                        <h5>Use clear, benefit-focused names</h5>
                        <p>"Premium Monthly" vs "Plan A"</p>
                    </div>
                </div>
                <div class="tip-item">
                    <div class="tip-icon">üí∞</div>
                    <div class="tip-content">
                        <h5>Price psychology</h5>
                        <p>$29.99 feels better than $30</p>
                    </div>
                </div>
                <div class="tip-item">
                    <div class="tip-icon">üìù</div>
                    <div class="tip-content">
                        <h5>Feature benefits</h5>
                        <p>Focus on outcomes, not features</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Analytics Card -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3 class="card-title">Plan Analytics</h3>
            <div class="card-icon">üìä</div>
        </div>
        <div class="card-content">
            <div class="analytics-preview">
                <div class="metric-item">
                    <span class="metric-label">Est. Monthly Revenue</span>
                    <span class="metric-value" id="est-revenue">$0</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Break-even Point</span>
                    <span class="metric-value" id="break-even">0 subscribers</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Profit Margin</span>
                    <span class="metric-value" id="profit-margin">0%</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<style>
/* Dashboard Grid Layout */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.dashboard-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(226, 232, 240, 0.8);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
}

.dashboard-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
    border-color: rgba(79, 70, 229, 0.2);
}

.card-header {
    padding: 1.25rem 1.5rem 0.75rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.card-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
    letter-spacing: -0.025em;
}

.card-icon {
    font-size: 1.5rem;
    opacity: 0.8;
    transition: all 0.3s ease;
}

.dashboard-card:hover .card-icon {
    opacity: 1;
    transform: scale(1.1);
}

.card-content {
    padding: 1.25rem 1.5rem;
}

/* Form Styles */
.plan-form {
    margin-top: 0.5rem;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.form-input {
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
    background: white;
    color: #1f2937;
}

.form-input:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-input::placeholder {
    color: #9ca3af;
}

.form-input[rows] {
    resize: vertical;
    min-height: 100px;
}

small {
    color: #6b7280;
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.price-input-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.currency-symbol,
.price-period {
    color: #6b7280;
    font-weight: 600;
    font-size: 1rem;
}

.price-input {
    flex: 1;
    text-align: center;
    font-size: 1.25rem;
    font-weight: 600;
}

.features-builder {
    margin-top: 0.5rem;
}

.features-input-group {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.features-input-group .form-input {
    flex: 1;
}

.features-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-height: 100px;
    padding: 1rem;
    border: 2px dashed #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
}

.feature-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
}

.feature-item:hover {
    border-color: #4f46e5;
    background: #f8fafc;
}

.feature-text {
    flex: 1;
    font-size: 0.9rem;
    color: #374151;
}

.remove-feature {
    color: #dc2626;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.remove-feature:hover {
    background: #fef2f2;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e2e8f0;
}

/* Plan Preview */
.plan-preview {
    margin-top: 0.5rem;
}

.plan-card {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.plan-header {
    text-align: center;
    margin-bottom: 1rem;
}

.plan-header h4 {
    margin: 0 0 0.5rem 0;
    color: #1f2937;
    font-size: 1.25rem;
    font-weight: 600;
}

.plan-price {
    font-size: 1.75rem;
    font-weight: 800;
    color: #4f46e5;
    margin-bottom: 1rem;
}

.plan-description {
    color: #6b7280;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 1rem;
}

.plan-features {
    list-style: none;
    padding: 0;
    margin-bottom: 1rem;
}

.plan-features li {
    padding: 0.5rem 0;
    color: #374151;
    border-bottom: 1px solid #f3f4f6;
    position: relative;
    padding-left: 1.5rem;
    font-size: 0.875rem;
}

.plan-features li:last-child {
    border-bottom: none;
}

.plan-features li::before {
    content: '‚úì';
    color: #059669;
    font-weight: bold;
    position: absolute;
    left: 0;
}

.plan-status {
    text-align: center;
}

.status-badge {
    padding: 0.375rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    background: #d1fae5;
    color: #059669;
}

/* Tips List */
.tips-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.tip-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 8px;
    border: 1px solid rgba(226, 232, 240, 0.6);
}

.tip-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    flex-shrink: 0;
}

.tip-content h5 {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 0.25rem 0;
}

.tip-content p {
    font-size: 0.8rem;
    color: #64748b;
    margin: 0;
    line-height: 1.4;
}

/* Analytics Preview */
.analytics-preview {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
}

.metric-label {
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
}

.metric-value {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 600;
}

/* Action Buttons */
.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.25rem;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
    min-height: 44px;
}

.action-btn:hover {
    background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(79, 70, 229, 0.3);
    color: white;
    text-decoration: none;
}

.action-btn.secondary {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
}

.action-btn.secondary:hover {
    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
}

/* Page Header */
.page-header {
    margin-bottom: 2rem;
    text-align: center;
    padding: 1rem 0;
}

.page-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: #1f2937;
    margin-bottom: 0.5rem;
    letter-spacing: -0.05em;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.page-subtitle {
    font-size: 1.1rem;
    color: #64748b;
    font-weight: 500;
    max-width: 600px;
    margin: 0 auto;
}

/* Responsive Design */
@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .dashboard-card {
        margin: 0 0.5rem;
    }

    .card-header {
        padding: 1rem 1.25rem 0.5rem;
    }

    .card-content {
        padding: 1rem 1.25rem;
    }

    .page-title {
        font-size: 2rem;
    }

    .page-subtitle {
        font-size: 1rem;
    }

    .form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .features-input-group {
        flex-direction: column;
    }

    .features-input-group .action-btn {
        width: 100%;
        justify-content: center;
    }

    .form-actions {
        flex-direction: column;
        gap: 0.75rem;
    }

    .action-btn {
        width: 100%;
        justify-content: center;
        min-height: 48px;
    }

    .plan-card {
        padding: 1.25rem;
    }

    .plan-header h4 {
        font-size: 1.1rem;
    }

    .plan-price {
        font-size: 1.5rem;
    }

    .tips-list {
        gap: 0.75rem;
    }

    .tip-item {
        padding: 0.625rem;
    }

    .tip-icon {
        width: 28px;
        height: 28px;
        font-size: 0.875rem;
    }
}

@media (max-width: 480px) {
    .page-title {
        font-size: 1.75rem;
    }

    .card-title {
        font-size: 1rem;
    }

    .form-input {
        padding: 1rem;
        font-size: 1rem;
    }

    .price-input {
        font-size: 1.1rem;
    }

    .features-list {
        padding: 0.75rem;
    }

    .feature-item {
        padding: 0.625rem;
    }

    .plan-card {
        padding: 1rem;
    }

    .plan-header h4 {
        font-size: 1rem;
    }

    .plan-price {
        font-size: 1.25rem;
    }

    .tip-content h5 {
        font-size: 0.85rem;
    }

    .tip-content p {
        font-size: 0.75rem;
    }
}

/* Animation for cards */
@keyframes cardSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dashboard-card {
    animation: cardSlideIn 0.6s ease-out;
}

.dashboard-card:nth-child(1) { animation-delay: 0.1s; }
.dashboard-card:nth-child(2) { animation-delay: 0.2s; }
.dashboard-card:nth-child(3) { animation-delay: 0.3s; }
.dashboard-card:nth-child(4) { animation-delay: 0.4s; }

/* Dark theme support */
body.dark-theme .dashboard-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-color: rgba(71, 85, 105, 0.8);
}

body.dark-theme .card-header {
    background: linear-gradient(135deg, #334155 0%, #475569 100%);
    border-color: #475569;
}

body.dark-theme .card-title {
    color: #f1f5f9;
}

body.dark-theme .form-label {
    color: #94a3b8;
}

body.dark-theme .form-input {
    background: #334155;
    border-color: #475569;
    color: #f1f5f9;
}

body.dark-theme .form-input::placeholder {
    color: #64748b;
}

body.dark-theme .form-input:focus {
    border-color: #60a5fa;
}

body.dark-theme .features-list {
    background: #334155;
    border-color: #475569;
}

body.dark-theme .feature-item {
    background: #475569;
    border-color: #64748b;
    color: #f1f5f9;
}

body.dark-theme .plan-card {
    background: #334155;
    border-color: #475569;
}

body.dark-theme .plan-header h4 {
    color: #f1f5f9;
}

body.dark-theme .plan-description {
    color: #94a3b8;
}

body.dark-theme .plan-features li {
    color: #e2e8f0;
    border-color: #475569;
}

body.dark-theme .tip-item {
    background: linear-gradient(135deg, #334155 0%, #475569 100%);
    border-color: rgba(71, 85, 105, 0.6);
}

body.dark-theme .tip-content h5 {
    color: #f1f5f9;
}

body.dark-theme .tip-content p {
    color: #94a3b8;
}

body.dark-theme .metric-label {
    color: #94a3b8;
}

body.dark-theme .metric-value {
    color: #f1f5f9;
}

body.dark-theme .page-title {
    background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

body.dark-theme .page-subtitle {
    color: #94a3b8;
}
</style>

<script>
// Features management
let features = [];

function addFeature() {
    const input = document.getElementById('feature-input');
    const featureText = input.value.trim();

    if (featureText) {
        features.push(featureText);
        updateFeaturesList();
        updateFeaturesPreview();
        updateAnalytics();
        input.value = '';
        input.focus();
    }
}

function removeFeature(index) {
    features.splice(index, 1);
    updateFeaturesList();
    updateFeaturesPreview();
    updateAnalytics();
}

function updateFeaturesList() {
    const featuresList = document.getElementById('features-list');
    featuresList.innerHTML = '';

    features.forEach((feature, index) => {
        const featureItem = document.createElement('div');
        featureItem.className = 'feature-item';
        featureItem.innerHTML = `
            <span class="feature-text">${feature}</span>
            <button type="button" class="remove-feature" onclick="removeFeature(${index})" aria-label="Remove feature">
                ‚úï
            </button>
        `;
        featuresList.appendChild(featureItem);
    });

    // Update hidden inputs
    const hiddenInputs = document.getElementById('features-hidden-inputs');
    hiddenInputs.innerHTML = '';
    features.forEach(feature => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'features';
        input.value = feature;
        hiddenInputs.appendChild(input);
    });
}

function updateFeaturesPreview() {
    const previewFeatures = document.getElementById('preview-features');
    previewFeatures.innerHTML = '';

    if (features.length > 0) {
        features.forEach(feature => {
            const li = document.createElement('li');
            li.textContent = feature;
            previewFeatures.appendChild(li);
        });
    } else {
        // Default features for preview
        const defaultFeatures = ['Unlimited counseling sessions', '24/7 priority support', 'Advanced mood analytics', 'Custom report generation'];
        defaultFeatures.forEach(feature => {
            const li = document.createElement('li');
            li.textContent = feature;
            previewFeatures.appendChild(li);
        });
    }
}

function updateAnalytics() {
    const priceInput = document.getElementById('id_price_monthly');
    const price = parseFloat(priceInput.value) || 29.99;

    // Calculate estimated revenue (assuming 10 subscribers)
    const estRevenue = (price * 10).toFixed(0);
    document.getElementById('est-revenue').textContent = '$' + estRevenue;

    // Calculate break-even (assuming $500 fixed costs)
    const breakEven = Math.ceil(500 / price);
    document.getElementById('break-even').textContent = breakEven + ' subscribers';

    // Calculate profit margin (assuming 70% margin after costs)
    const profitMargin = '70%';
    document.getElementById('profit-margin').textContent = profitMargin;
}

// Live preview updates
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('id_display_name');
    const descriptionInput = document.getElementById('id_description');
    const priceInput = document.getElementById('id_price_monthly');

    const previewName = document.getElementById('preview-name');
    const previewDescription = document.getElementById('preview-description');
    const previewPrice = document.getElementById('preview-price');

    function updatePreview() {
        previewName.textContent = nameInput.value || 'Premium Monthly';
        previewDescription.textContent = descriptionInput.value || 'Access to all premium features including unlimited sessions, priority support, and advanced analytics.';
        previewPrice.textContent = priceInput.value ? `$${parseFloat(priceInput.value).toFixed(2)}/month` : '$29.99/month';
        updateAnalytics();
    }

    nameInput.addEventListener('input', updatePreview);
    descriptionInput.addEventListener('input', updatePreview);
    priceInput.addEventListener('input', updatePreview);

    // Handle Enter key in feature input
    document.getElementById('feature-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addFeature();
        }
    });

    // Add loading animation to cards
    const cards = document.querySelectorAll('.dashboard-card');
    cards.forEach(card => {
        card.classList.add('loading');
        setTimeout(() => {
            card.classList.remove('loading');
        }, 1000);
    });

    // Initialize
    updatePreview();
    updateFeaturesPreview();
    updateAnalytics();
});
</script>
{% endblock %}
{% endblock %}