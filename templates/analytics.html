{% extends "base.html" %}

{% block title %}Analytics - SafeTalk{% endblock %}

{% block extra_head %}
    <style>
        .analytics-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            height: calc(100vh - 200px);
        }

        .analytics-sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .filter-section {
            margin-bottom: 2rem;
        }

        .filter-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .filter-select,
        .filter-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .analytics-main {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 2rem;
            overflow-y: auto;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .analytics-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
        }

        .export-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .export-btn:hover {
            background: #3730a3;
        }

        .analytics-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .analytics-content {
            display: none;
        }

        .analytics-content.active {
            display: block;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #4f46e5;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #4f46e5;
            display: block;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            color: #059669;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .chart-placeholder {
            height: 300px;
            background: #f8fafc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .insights-list {
            display: grid;
            gap: 1rem;
        }

        .insight-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #fbbf24;
        }

        .insight-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .insight-description {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .reports-section {
            margin-top: 2rem;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .report-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .report-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #4f46e5;
        }

        .report-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #4f46e5;
        }

        .report-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .report-description {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .date-range-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
        }

        .date-input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .apply-filters-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .apply-filters-btn:hover {
            background: #3730a3;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #fecaca;
        }

        @media (max-width: 768px) {
            .analytics-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .analytics-sidebar {
                display: none;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }

            .reports-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="analytics-layout">
        <!-- Sidebar Filters -->
        <div class="analytics-sidebar">
            <div class="filter-section">
                <h3 class="filter-title">Filters</h3>

                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <select class="filter-select" id="dateRangeFilter">
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="1y">Last year</option>
                        <option value="all">All time</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Metric Type</label>
                    <select class="filter-select" id="metricFilter">
                        <option value="all">All Metrics</option>
                        <option value="users">User Activity</option>
                        <option value="content">Content Performance</option>
                        <option value="appointments">Appointments</option>
                        <option value="engagement">Engagement</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Group By</label>
                    <select class="filter-select" id="groupByFilter">
                        <option value="day">Daily</option>
                        <option value="week">Weekly</option>
                        <option value="month">Monthly</option>
                    </select>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">Quick Actions</h3>
                <button class="export-btn" onclick="exportAnalytics()" style="width: 100%; margin-bottom: 0.5rem;">Export Report</button>
                <button class="export-btn" onclick="scheduleReport()" style="width: 100%; background: #6b7280;">Schedule Report</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="analytics-main">
            <div class="analytics-header">
                <h1 class="analytics-title">Analytics Dashboard</h1>
                <button class="export-btn" onclick="exportAnalytics()">Export Data</button>
            </div>

            <!-- Date Range Selector -->
            <div class="date-range-selector">
                <label for="startDate">From:</label>
                <input type="date" class="date-input" id="startDate">
                <label for="endDate">To:</label>
                <input type="date" class="date-input" id="endDate">
                <button class="apply-filters-btn" onclick="applyDateFilter()">Apply</button>
            </div>

            <!-- Analytics Tabs -->
            <div class="analytics-tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                <button class="tab-btn" onclick="switchTab('users')">Users</button>
                <button class="tab-btn" onclick="switchTab('content')">Content</button>
                <button class="tab-btn" onclick="switchTab('appointments')">Appointments</button>
                <button class="tab-btn" onclick="switchTab('insights')">Insights</button>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="analytics-content active">
                <div class="stats-overview" id="overviewStats">
                    <!-- Stats will be loaded here -->
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">User Growth</h3>
                        <div class="chart-placeholder" id="userGrowthChart">
                            📈 Chart will be loaded here
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Content Engagement</h3>
                        <div class="chart-placeholder" id="contentEngagementChart">
                            📊 Chart will be loaded here
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Appointment Trends</h3>
                        <div class="chart-placeholder" id="appointmentTrendsChart">
                            📅 Chart will be loaded here
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Revenue Overview</h3>
                        <div class="chart-placeholder" id="revenueChart">
                            💰 Chart will be loaded here
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="analytics-content">
                <div class="stats-overview" id="userStats">
                    <!-- User stats will be loaded here -->
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">User Registration Trends</h3>
                        <div class="chart-placeholder" id="registrationChart">
                            📈 Registration trends
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">User Activity Heatmap</h3>
                        <div class="chart-placeholder" id="activityHeatmap">
                            🔥 Activity patterns
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Top Active Users</h3>
                    <table class="data-table" id="topUsersTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Appointments</th>
                                <th>Content Views</th>
                                <th>Last Active</th>
                            </tr>
                        </thead>
                        <tbody id="topUsersBody">
                            <!-- User data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Content Tab -->
            <div id="contentTab" class="analytics-content">
                <div class="stats-overview" id="contentStats">
                    <!-- Content stats will be loaded here -->
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Content Performance</h3>
                        <div class="chart-placeholder" id="contentPerformanceChart">
                            📈 Content metrics
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Popular Categories</h3>
                        <div class="chart-placeholder" id="categoryChart">
                            🏷️ Category breakdown
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Top Performing Content</h3>
                    <table class="data-table" id="topContentTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Views</th>
                                <th>Avg Rating</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody id="topContentBody">
                            <!-- Content data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Appointments Tab -->
            <div id="appointmentsTab" class="analytics-content">
                <div class="stats-overview" id="appointmentStats">
                    <!-- Appointment stats will be loaded here -->
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Appointment Bookings</h3>
                        <div class="chart-placeholder" id="bookingChart">
                            📅 Booking trends
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Counselor Performance</h3>
                        <div class="chart-placeholder" id="counselorPerformanceChart">
                            👥 Counselor metrics
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Appointment Details</h3>
                    <table class="data-table" id="appointmentsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Counselor</th>
                                <th>Status</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentsBody">
                            <!-- Appointment data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="insightsTab" class="analytics-content">
                <div class="insights-list" id="insightsList">
                    <!-- AI-generated insights will be loaded here -->
                </div>

                <div class="reports-section">
                    <h3 style="margin-bottom: 1rem; color: #1f2937;">Available Reports</h3>
                    <div class="reports-grid">
                        <div class="report-card" onclick="generateReport('user-engagement')">
                            <div class="report-icon">👥</div>
                            <h4 class="report-title">User Engagement Report</h4>
                            <p class="report-description">Detailed analysis of user activity and engagement patterns</p>
                        </div>

                        <div class="report-card" onclick="generateReport('content-performance')">
                            <div class="report-icon">📊</div>
                            <h4 class="report-title">Content Performance</h4>
                            <p class="report-description">Insights into content effectiveness and user preferences</p>
                        </div>

                        <div class="report-card" onclick="generateReport('appointment-analytics')">
                            <div class="report-icon">📅</div>
                            <h4 class="report-title">Appointment Analytics</h4>
                            <p class="report-description">Comprehensive appointment booking and completion analysis</p>
                        </div>

                        <div class="report-card" onclick="generateReport('revenue-report')">
                            <div class="report-icon">💰</div>
                            <h4 class="report-title">Revenue Report</h4>
                            <p class="report-description">Financial performance and subscription metrics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        let currentUser = null;
        let accessToken = null;
        let currentTab = 'overview';
        let currentFilters = {
            dateRange: '30d',
            metricType: 'all',
            groupBy: 'month',
            startDate: '',
            endDate: ''
        };

        document.addEventListener('DOMContentLoaded', function() {
            accessToken = localStorage.getItem('access_token');
            const userData = localStorage.getItem('user');

            if (!accessToken || !userData) {
                window.location.href = '/login/';
                return;
            }

            currentUser = JSON.parse(userData);

            // Check if user is admin
            if (currentUser.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = '/dashboard/';
                return;
            }

            initializeAnalytics();
        });

        function initializeAnalytics() {
            setupEventListeners();
            setDefaultDateRange();
            loadAnalyticsData();
        }

        function setupEventListeners() {
            // Filter changes
            document.getElementById('dateRangeFilter').addEventListener('change', function(e) {
                currentFilters.dateRange = e.target.value;
                loadAnalyticsData();
            });

            document.getElementById('metricFilter').addEventListener('change', function(e) {
                currentFilters.metricType = e.target.value;
                loadAnalyticsData();
            });

            document.getElementById('groupByFilter').addEventListener('change', function(e) {
                currentFilters.groupBy = e.target.value;
                loadAnalyticsData();
            });
        }

        function setDefaultDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

            currentFilters.startDate = startDate.toISOString().split('T')[0];
            currentFilters.endDate = endDate.toISOString().split('T')[0];
        }

        function applyDateFilter() {
            currentFilters.startDate = document.getElementById('startDate').value;
            currentFilters.endDate = document.getElementById('endDate').value;
            loadAnalyticsData();
        }

        async function apiCall(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                },
            };

            const response = await fetch(endpoint, { ...defaultOptions, ...options });
            if (response.status === 401) {
                logout();
                return;
            }
            return response.json();
        }

        async function loadAnalyticsData() {
            try {
                showLoading();

                const params = new URLSearchParams({
                    date_range: currentFilters.dateRange,
                    metric_type: currentFilters.metricType,
                    group_by: currentFilters.groupBy,
                    start_date: currentFilters.startDate,
                    end_date: currentFilters.endDate
                });

                const data = await apiCall(`/api/analytics/dashboard/?${params}`);

                displayOverviewStats(data.overview || {});
                displayUserStats(data.users || {});
                displayContentStats(data.content || {});
                displayAppointmentStats(data.appointments || {});
                displayInsights(data.insights || []);

                hideLoading();
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showError('Failed to load analytics data. Please try again.');
                hideLoading();
            }
        }

        function displayOverviewStats(stats) {
            const container = document.getElementById('overviewStats');
            container.innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.total_users || 0}</span>
                    <span class="stat-label">Total Users</span>
                    <div class="stat-change positive">+${stats.user_growth || 0}%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.active_users || 0}</span>
                    <span class="stat-label">Active Users</span>
                    <div class="stat-change positive">+${stats.active_growth || 0}%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.total_sessions || 0}</span>
                    <span class="stat-label">Total Sessions</span>
                    <div class="stat-change positive">+${stats.session_growth || 0}%</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">$${stats.revenue || 0}</span>
                    <span class="stat-label">Revenue</span>
                    <div class="stat-change positive">+${stats.revenue_growth || 0}%</div>
                </div>
            `;
        }

        function displayUserStats(stats) {
            const container = document.getElementById('userStats');
            container.innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.new_registrations || 0}</span>
                    <span class="stat-label">New Registrations</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.returning_users || 0}</span>
                    <span class="stat-label">Returning Users</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.avg_session_duration || 0}m</span>
                    <span class="stat-label">Avg Session Time</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.user_retention || 0}%</span>
                    <span class="stat-label">Retention Rate</span>
                </div>
            `;

            // Display top users table
            const tbody = document.getElementById('topUsersBody');
            if (stats.top_users && stats.top_users.length > 0) {
                tbody.innerHTML = stats.top_users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td>${user.appointments}</td>
                        <td>${user.content_views}</td>
                        <td>${new Date(user.last_active).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No user data available</td></tr>';
            }
        }

        function displayContentStats(stats) {
            const container = document.getElementById('contentStats');
            container.innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.total_content || 0}</span>
                    <span class="stat-label">Total Content</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.total_views || 0}</span>
                    <span class="stat-label">Total Views</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.avg_rating || 0}</span>
                    <span class="stat-label">Avg Rating</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.engagement_rate || 0}%</span>
                    <span class="stat-label">Engagement Rate</span>
                </div>
            `;

            // Display top content table
            const tbody = document.getElementById('topContentBody');
            if (stats.top_content && stats.top_content.length > 0) {
                tbody.innerHTML = stats.top_content.map(content => `
                    <tr>
                        <td>${content.title}</td>
                        <td>${content.category}</td>
                        <td>${content.views}</td>
                        <td>${content.avg_rating}</td>
                        <td>${new Date(content.created).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No content data available</td></tr>';
            }
        }

        function displayAppointmentStats(stats) {
            const container = document.getElementById('appointmentStats');
            container.innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.total_appointments || 0}</span>
                    <span class="stat-label">Total Appointments</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.completed_appointments || 0}</span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.avg_duration || 0}m</span>
                    <span class="stat-label">Avg Duration</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.satisfaction_rate || 0}%</span>
                    <span class="stat-label">Satisfaction Rate</span>
                </div>
            `;

            // Display appointments table
            const tbody = document.getElementById('appointmentsBody');
            if (stats.recent_appointments && stats.recent_appointments.length > 0) {
                tbody.innerHTML = stats.recent_appointments.map(apt => `
                    <tr>
                        <td>${new Date(apt.date).toLocaleDateString()}</td>
                        <td>${apt.client_name}</td>
                        <td>${apt.counselor_name}</td>
                        <td><span class="status-${apt.status}">${apt.status}</span></td>
                        <td>${apt.duration}min</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No appointment data available</td></tr>';
            }
        }

        function displayInsights(insights) {
            const container = document.getElementById('insightsList');

            if (!insights || insights.length === 0) {
                container.innerHTML = '<div class="insight-card"><div class="insight-title">No insights available</div><div class="insight-description">Insights will be generated based on your data patterns.</div></div>';
                return;
            }

            container.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-description">${insight.description}</div>
                </div>
            `).join('');
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.analytics-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            currentTab = tabName;
        }

        async function exportAnalytics() {
            try {
                const params = new URLSearchParams({
                    date_range: currentFilters.dateRange,
                    metric_type: currentFilters.metricType,
                    group_by: currentFilters.groupBy,
                    start_date: currentFilters.startDate,
                    end_date: currentFilters.endDate,
                    format: 'csv'
                });

                const response = await fetch(`/api/analytics/export/?${params}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                    },
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `safetalk_analytics_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    alert('Analytics data exported successfully!');
                } else {
                    alert('Failed to export analytics data. Please try again.');
                }
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export analytics data. Please try again.');
            }
        }

        function scheduleReport() {
            alert('Report scheduling functionality would be implemented here');
        }

        function generateReport(reportType) {
            alert(`Generating ${reportType} report... This functionality would be implemented here`);
        }

        function showLoading() {
            // Add loading indicators to charts and tables
            document.querySelectorAll('.chart-placeholder').forEach(el => {
                el.innerHTML = '<div class="loading">Loading chart data...</div>';
            });
        }

        function hideLoading() {
            // Remove loading indicators
            document.querySelectorAll('.loading').forEach(el => {
                el.parentElement.innerHTML = '📊 Chart data loaded';
            });
        }

        function showError(message) {
            const container = document.querySelector('.analytics-main');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }
    </script>
{% endblock %}