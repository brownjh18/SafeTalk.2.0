{% extends "base.html" %}

{% block title %}Appointment Management - SafeTalk{% endblock %}

{% block extra_head %}
    <style>
        /* Search and Filter Section */
        .search-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(10px);
        }

        .search-controls {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .search-input:focus {
            outline: none;
            border-color: #4f46e5;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            transform: scale(1.02);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }

        .search-input:focus + .search-icon {
            color: #4f46e5;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
    </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Appointment Management</h1>
    <p class="page-subtitle">Manage and schedule counseling sessions</p>
</div>

<!-- Search and Filter Section -->
<div class="search-section">
    <div class="search-controls">
        <div class="search-input-wrapper">
            <input
                type="text"
                class="search-input"
                placeholder="Search appointments..."
                id="searchInput"
            >
            <div class="search-icon">üîç</div>
        </div>

        <select class="filter-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="scheduled">Scheduled</option>
            <option value="confirmed">Confirmed</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
        </select>

        <select class="filter-select" id="dateFilter">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
        </select>

        <button class="action-btn schedule-btn" onclick="openScheduleModal()">
            <i class="btn-icon">üìÖ</i>
            <span>Schedule New</span>
            <div class="btn-glow"></div>
        </button>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Appointment Stats Card -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3 class="card-title">Appointment Overview</h3>
            <div class="card-icon">üìä</div>
        </div>
        <div class="card-content">
            <div class="appointment-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Appointments</span>
                    <span class="stat-value" id="totalAppointments">Loading...</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Upcoming</span>
                    <span class="stat-value" id="upcomingAppointments">Loading...</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Today</span>
                    <span class="stat-value" id="todayAppointments">Loading...</span>
                </div>
            </div>
            <button class="action-btn view-calendar-btn" onclick="toggleCalendar()">
                <i class="btn-icon">üìÖ</i>
                <span>View Calendar</span>
                <div class="btn-ripple"></div>
            </button>
        </div>
    </div>

    <!-- Quick Actions Card -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
            <div class="card-icon">‚ö°</div>
        </div>
        <div class="card-content">
            <div class="quick-actions-grid">
                <button class="action-btn today-btn" onclick="filterByDate('today')">
                    <i class="btn-icon">üìÜ</i>
                    <span>Today's Appointments</span>
                </button>
                <button class="action-btn week-btn" onclick="filterByDate('week')">
                    <i class="btn-icon">üìÖ</i>
                    <span>This Week</span>
                </button>
                <button class="action-btn pending-btn" onclick="filterByStatus('scheduled')">
                    <i class="btn-icon">‚è≥</i>
                    <span>Pending</span>
                </button>
                <button class="action-btn completed-btn" onclick="filterByStatus('completed')">
                    <i class="btn-icon">‚úÖ</i>
                    <span>Completed</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Appointments List -->
<div class="appointments-section">
    <h3>Recent Appointments</h3>
    <div class="appointments-list" id="appointmentsList">
        <!-- Appointments will be loaded here -->
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading appointments...</p>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination">
        <!-- Pagination will be loaded here -->
    </div>
</div>

<!-- Mini Calendar (Collapsible) -->
<div class="mini-calendar" id="miniCalendar" style="display: none;">
    <div class="calendar-section">
        <h3>Calendar View</h3>
        <div class="calendar-header">
            <h4 class="calendar-title" id="calendarTitle">October 2024</h4>
            <div class="calendar-nav">
                <button class="nav-btn" onclick="previousMonth()">&larr;</button>
                <button class="nav-btn" onclick="nextMonth()">&rarr;</button>
                <button class="nav-btn" onclick="goToToday()">Today</button>
            </div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar will be generated here -->
        </div>
    </div>
</div>

    <!-- Schedule Appointment Modal -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Schedule New Appointment</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="appointmentForm">
                <div class="form-group">
                    <label class="form-label">Client</label>
                    <select class="form-select" id="clientSelect" name="client" required>
                        <option value="">Select Client</option>
                        <!-- Clients will be loaded here -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Counselor</label>
                    <select class="form-select" id="counselorSelect" name="counselor" required>
                        <option value="">Select Counselor</option>
                        <!-- Counselors will be loaded here -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="appointmentTitle" name="title" placeholder="Appointment title" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Date & Time</label>
                    <input type="datetime-local" class="form-input" id="appointmentDateTime" name="scheduled_date" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Duration (minutes)</label>
                    <select class="form-select" id="appointmentDuration" name="duration">
                        <option value="30">30 minutes</option>
                        <option value="60" selected>60 minutes</option>
                        <option value="90">90 minutes</option>
                        <option value="120">120 minutes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="appointmentDescription" name="description" placeholder="Appointment description..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="action-btn primary schedule-submit-btn">
                        <i class="btn-icon">üìÖ</i>
                        <span>Schedule Appointment</span>
                        <div class="btn-ripple"></div>
                    </button>
                    <button type="button" class="action-btn secondary" onclick="closeModal()">
                        <i class="btn-icon">‚ùå</i>
                        <span>Cancel</span>
                        <div class="btn-effect"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Appointment Details Modal -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Appointment Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div id="appointmentDetails">
                <!-- Appointment details will be loaded here -->
            </div>

            <div class="modal-actions">
                <button class="action-btn primary edit-btn" onclick="editAppointment()">
                    <i class="btn-icon">‚úèÔ∏è</i>
                    <span>Edit Appointment</span>
                    <div class="btn-ripple"></div>
                </button>
                <button class="action-btn danger cancel-btn" onclick="cancelAppointment()">
                    <i class="btn-icon">üö´</i>
                    <span>Cancel Appointment</span>
                    <div class="btn-pulse"></div>
                </button>
                <button class="action-btn secondary close-btn-modal" onclick="closeModal()">
                    <i class="btn-icon">‚úñÔ∏è</i>
                    <span>Close</span>
                    <div class="btn-effect"></div>
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<style>
/* Appointments Page Enhanced Styles */
.appointments-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(226, 232, 240, 0.8);
    backdrop-filter: blur(10px);
}

.appointments-section h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1rem;
    letter-spacing: -0.025em;
}

.appointments-list {
    display: grid;
    gap: 1rem;
    margin-bottom: 2rem;
}

.appointment-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(226, 232, 240, 0.8);
    padding: 1.5rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.appointment-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
    border-color: rgba(79, 70, 229, 0.2);
}

.appointment-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
}

.appointment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    gap: 1rem;
}

.appointment-time {
    font-weight: 700;
    color: #4f46e5;
    font-size: 1.1rem;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.appointment-status {
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: capitalize;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.status-scheduled {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
}

.status-confirmed {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.status-in_progress {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
}

.status-completed {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.status-cancelled {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #dc2626;
}

.appointment-client {
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.appointment-counselor {
    color: #64748b;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    font-weight: 500;
}

.appointment-title {
    color: #374151;
    margin-bottom: 1rem;
    font-weight: 500;
    line-height: 1.4;
}

.appointment-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

/* Appointment Stats */
.appointment-stats {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

/* Quick Access Grid */
.quick-actions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}

/* Mini Calendar Styles */
.mini-calendar {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(226, 232, 240, 0.8);
    backdrop-filter: blur(10px);
}

.calendar-section h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1rem;
    letter-spacing: -0.025em;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.calendar-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
}

.calendar-nav {
    display: flex;
    gap: 0.5rem;
}

.nav-btn {
    padding: 0.5rem 0.75rem;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    font-weight: 500;
}

.nav-btn:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    border-color: #4f46e5;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.calendar-day-header {
    text-align: center;
    font-weight: 600;
    color: #64748b;
    padding: 0.5rem;
    font-size: 0.8rem;
}

.calendar-day {
    aspect-ratio: 1;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.calendar-day:hover {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-color: #4f46e5;
    transform: scale(1.05);
}

.calendar-day.today {
    background: linear-gradient(135deg, #eef2ff 0%, #c7d2fe 100%);
    border-color: #4f46e5;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
}

.calendar-day.other-month {
    color: #9ca3af;
    background: #f9fafb;
}

.day-number {
    font-weight: 600;
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.day-appointments {
    font-size: 0.7rem;
    color: #64748b;
    text-align: center;
}

.appointment-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    display: inline-block;
    margin: 1px;
    box-shadow: 0 1px 3px rgba(79, 70, 229, 0.3);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
}

.modal.show {
    display: flex;
    animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.modal-content {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(226, 232, 240, 0.8);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-header {
    padding: 2rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: #1f2937;
    margin: 0;
    letter-spacing: -0.025em;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #64748b;
    padding: 0.5rem;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.close-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.form-group {
    margin-bottom: 1.5rem;
    padding: 0 2rem;
}

.form-label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
}

.form-input,
.form-textarea,
.form-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.form-input:focus,
.form-textarea:focus,
.form-select:focus {
    outline: none;
    border-color: #4f46e5;
    background: white;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    transform: scale(1.02);
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.modal-actions {
    padding: 2rem;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

/* Loading State */
.loading-state {
    text-align: center;
    padding: 3rem;
    color: #64748b;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e2e8f0;
    border-top: 3px solid #4f46e5;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.page-btn {
    padding: 0.625rem 1rem;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    font-weight: 500;
    min-height: 40px;
}

.page-btn:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    border-color: #4f46e5;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.page-btn.active {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    border-color: #4f46e5;
    box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .search-controls {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .appointments-section {
        margin: 1rem 0.5rem 0.5rem;
        padding: 1.25rem;
    }

    .appointment-card {
        padding: 1.25rem;
    }

    .appointment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .appointment-actions {
        flex-direction: column;
        gap: 0.5rem;
    }

    .modal-content {
        width: 95%;
        margin: 1rem;
        border-radius: 16px;
    }

    .modal-header,
    .modal-actions {
        padding: 1.5rem;
    }

    .form-group {
        padding: 0 1.5rem;
    }

    .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        font-size: 0.75rem;
    }

    .calendar-day {
        padding: 0.25rem;
    }

    .day-number {
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .appointment-client {
        font-size: 0.9rem;
    }

    .appointment-counselor {
        font-size: 0.8rem;
    }

    .appointment-title {
        font-size: 0.875rem;
    }

    .modal-title {
        font-size: 1.25rem;
    }

    .form-input,
    .form-select {
        font-size: 0.9rem;
        padding: 0.625rem;
    }
}

/* Animation for cards */
@keyframes appointmentSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.appointment-card {
    animation: appointmentSlideIn 0.6s ease-out;
}

.appointment-card:nth-child(1) { animation-delay: 0.1s; }
.appointment-card:nth-child(2) { animation-delay: 0.2s; }
.appointment-card:nth-child(3) { animation-delay: 0.3s; }
.appointment-card:nth-child(4) { animation-delay: 0.4s; }
.appointment-card:nth-child(5) { animation-delay: 0.5s; }

/* Dark theme support */
body.dark-theme .appointments-section {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-color: rgba(71, 85, 105, 0.8);
}

body.dark-theme .appointments-section h3 {
    color: #f1f5f9;
}

body.dark-theme .appointment-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-color: rgba(71, 85, 105, 0.8);
}

body.dark-theme .appointment-client {
    color: #f1f5f9;
}

body.dark-theme .appointment-counselor {
    color: #94a3b8;
}

body.dark-theme .appointment-title {
    color: #cbd5e1;
}

body.dark-theme .modal-content {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-color: rgba(71, 85, 105, 0.8);
}

body.dark-theme .modal-title {
    color: #f1f5f9;
}

body.dark-theme .form-input,
body.dark-theme .form-select {
    background: #334155;
    border-color: #475569;
    color: #f1f5f9;
}

body.dark-theme .form-input::placeholder {
    color: #94a3b8;
}

body.dark-theme .calendar-day {
    background: #334155;
    border-color: #475569;
}

body.dark-theme .calendar-day.today {
    background: linear-gradient(135deg, #3730a3 0%, #4338ca 100%);
}

body.dark-theme .calendar-day.other-month {
    background: #1e293b;
    color: #64748b;
}
</style>

<script>
let currentUser = null;
let accessToken = null;
let currentFilters = {
    status: '',
    dateRange: 'all',
    counselor: '',
    search: '',
    page: 1
};
let currentDate = new Date();
let selectedAppointment = null;

document.addEventListener('DOMContentLoaded', function() {
    accessToken = localStorage.getItem('access_token');
    const userData = localStorage.getItem('user');

    if (!accessToken || !userData) {
        window.location.href = '/login/';
        return;
    }

    currentUser = JSON.parse(userData);

    // Check if user has appropriate permissions
    if (!['admin', 'counselor'].includes(currentUser.role)) {
        alert('Access denied. Admin or counselor privileges required.');
        window.location.href = '/dashboard/';
        return;
    }

    initializeAppointments();
});

function initializeAppointments() {
    setupEventListeners();
    loadAppointments();
    loadStats();
    loadCounselors();
    loadClients();
    generateCalendar();
}

function setupEventListeners() {
    // Search input with debounce
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentFilters.search = e.target.value;
            currentFilters.page = 1;
            loadAppointments();
        }, 500);
    });

    // Filter changes
    document.getElementById('statusFilter').addEventListener('change', function(e) {
        currentFilters.status = e.target.value;
        currentFilters.page = 1;
        loadAppointments();
    });

    document.getElementById('dateFilter').addEventListener('change', function(e) {
        currentFilters.dateRange = e.target.value;
        currentFilters.page = 1;
        loadAppointments();
    });

    // Appointment form
    document.getElementById('appointmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        scheduleAppointment();
    });
}

function applyFilters() {
    loadAppointments();
}

function filterByDate(dateRange) {
    document.getElementById('dateFilter').value = dateRange;
    currentFilters.dateRange = dateRange;
    currentFilters.page = 1;
    loadAppointments();
}

function filterByStatus(status) {
    document.getElementById('statusFilter').value = status;
    currentFilters.status = status;
    currentFilters.page = 1;
    loadAppointments();
}

function toggleCalendar() {
    const calendar = document.getElementById('miniCalendar');
    calendar.style.display = calendar.style.display === 'none' ? 'block' : 'none';
}

async function apiCall(endpoint, options = {}) {
    const defaultOptions = {
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
        },
    };

    const response = await fetch(endpoint, { ...defaultOptions, ...options });
    if (response.status === 401) {
        logout();
        return;
    }
    return response.json();
}

async function loadAppointments() {
    try {
        const loadingState = document.querySelector('.loading-state');
        if (loadingState) {
            loadingState.style.display = 'block';
        }

        const params = new URLSearchParams({
            page: currentFilters.page,
            status: currentFilters.status,
            date_range: currentFilters.dateRange,
            counselor: currentFilters.counselor,
            search: currentFilters.search
        });

        const data = await apiCall(`/api/admin/appointments/?${params}`);
        displayAppointments(data.results || data);
        displayPagination(data);
    } catch (error) {
        console.error('Error loading appointments:', error);
        showError('Failed to load appointments. Please try again.');
    }
}

async function loadStats() {
    try {
        const stats = await apiCall('/api/admin/appointments/stats/');
        displayStats(stats);
    } catch (error) {
        console.error('Error loading stats:', error);
        // Show default stats if API fails
        displayStats({
            total_appointments: 0,
            upcoming_appointments: 0,
            completed_appointments: 0,
            today_appointments: 0
        });
    }
}

async function loadCounselors() {
    try {
        const counselors = await apiCall('/api/users/counselors/');

        // Update counselor select in form
        const counselorSelect = document.getElementById('counselorSelect');
        counselorSelect.innerHTML = '<option value="">Select Counselor</option>' +
            counselors.map(c => `<option value="${c.id}">${c.first_name} ${c.last_name}</option>`).join('');
    } catch (error) {
        console.error('Error loading counselors:', error);
    }
}

async function loadClients() {
    try {
        const clients = await apiCall('/api/users/?role=client');

        const clientSelect = document.getElementById('clientSelect');
        clientSelect.innerHTML = '<option value="">Select Client</option>' +
            clients.map(c => `<option value="${c.id}">${c.first_name} ${c.last_name}</option>`).join('');
    } catch (error) {
        console.error('Error loading clients:', error);
    }
}

function displayStats(stats) {
    document.getElementById('totalAppointments').textContent = stats.total_appointments || 0;
    document.getElementById('upcomingAppointments').textContent = stats.upcoming_appointments || 0;
    document.getElementById('todayAppointments').textContent = stats.today_appointments || 0;
}

function displayAppointments(appointments) {
    const container = document.getElementById('appointmentsList');
    const loadingState = document.querySelector('.loading-state');

    if (loadingState) {
        loadingState.style.display = 'none';
    }

    if (!appointments || appointments.length === 0) {
        container.innerHTML = `
            <div class="no-appointments">
                <div class="empty-state">
                    <div class="empty-icon">üìÖ</div>
                    <h3>No appointments found</h3>
                    <p>No appointments match your current filters.</p>
                    <button class="action-btn schedule-btn" onclick="openScheduleModal()">
                        <i class="btn-icon">üìÖ</i>
                        <span>Schedule New</span>
                        <div class="btn-glow"></div>
                    </button>
                </div>
            </div>
        `;
        return;
    }

    container.innerHTML = appointments.map(appointment => `
        <div class="appointment-card" onclick="viewAppointmentDetails(${appointment.id})">
            <div class="appointment-header">
                <div class="appointment-time">${formatDateTime(appointment.scheduled_date)}</div>
                <span class="appointment-status status-${appointment.status}">${appointment.status.replace('_', ' ')}</span>
            </div>
            <div class="appointment-client">${appointment.client_name}</div>
            <div class="appointment-counselor">with ${appointment.counselor_name}</div>
            <div class="appointment-title">${appointment.title}</div>
            <div class="appointment-actions">
                <button class="action-btn primary start-btn" onclick="event.stopPropagation(); startAppointment(${appointment.id})">
                    <i class="btn-icon">‚ñ∂Ô∏è</i>
                    <span>Start</span>
                    <div class="btn-ripple"></div>
                </button>
                <button class="action-btn secondary edit-btn" onclick="event.stopPropagation(); editAppointment(${appointment.id})">
                    <i class="btn-icon">‚úèÔ∏è</i>
                    <span>Edit</span>
                    <div class="btn-effect"></div>
                </button>
                <button class="action-btn danger cancel-btn" onclick="event.stopPropagation(); cancelAppointment(${appointment.id})">
                    <i class="btn-icon">üö´</i>
                    <span>Cancel</span>
                    <div class="btn-pulse"></div>
                </button>
            </div>
        </div>
    `).join('');
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function displayPagination(data) {
    const container = document.getElementById('pagination');
    const totalPages = Math.ceil((data.count || 0) / 20);

    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }

    let paginationHTML = '';

    // Previous button
    if (currentFilters.page > 1) {
        paginationHTML += `<button class="page-btn" onclick="changePage(${currentFilters.page - 1})">Previous</button>`;
    }

    // Page numbers
    for (let i = Math.max(1, currentFilters.page - 2); i <= Math.min(totalPages, currentFilters.page + 2); i++) {
        paginationHTML += `<button class="page-btn ${i === currentFilters.page ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
    }

    // Next button
    if (currentFilters.page < totalPages) {
        paginationHTML += `<button class="page-btn" onclick="changePage(${currentFilters.page + 1})">Next</button>`;
    }

    container.innerHTML = paginationHTML;
}

function changePage(page) {
    currentFilters.page = page;
    loadAppointments();
    window.scrollTo(0, 0);
}

function generateCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    document.getElementById('calendarTitle').textContent =
        new Date(year, month).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';

    // Day headers
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
        calendarGrid.innerHTML += `<div class="calendar-day-header">${day}</div>`;
    });

    // Calendar days
    const currentDateIter = new Date(startDate);
    for (let i = 0; i < 42; i++) {
        const dayNumber = currentDateIter.getDate();
        const isCurrentMonth = currentDateIter.getMonth() === month;
        const isToday = currentDateIter.toDateString() === new Date().toDateString();

        const dayClass = `calendar-day ${isCurrentMonth ? '' : 'other-month'} ${isToday ? 'today' : ''}`;

        calendarGrid.innerHTML += `
            <div class="${dayClass}" onclick="selectDate('${currentDateIter.toISOString().split('T')[0]}')">
                <div class="day-number">${dayNumber}</div>
                <div class="day-appointments" id="day-${currentDateIter.toISOString().split('T')[0]}">
                    <!-- Appointments will be loaded here -->
                </div>
            </div>
        `;

        currentDateIter.setDate(currentDateIter.getDate() + 1);
    }

    // Load appointments for the month
    loadCalendarAppointments();
}

async function loadCalendarAppointments() {
    try {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        const appointments = await apiCall(`/api/admin/appointments/calendar/?year=${year}&month=${month}`);

        // Clear existing appointment indicators
        document.querySelectorAll('.day-appointments').forEach(el => {
            el.innerHTML = '';
        });

        // Add appointment indicators
        appointments.forEach(appointment => {
            const date = new Date(appointment.scheduled_date).toISOString().split('T')[0];
            const dayElement = document.getElementById(`day-${date}`);
            if (dayElement) {
                dayElement.innerHTML += '<span class="appointment-dot"></span>';
            }
        });
    } catch (error) {
        console.error('Error loading calendar appointments:', error);
    }
}

function selectDate(dateString) {
    currentFilters.dateRange = 'custom';
    currentFilters.customDate = dateString;
    currentFilters.page = 1;
    loadAppointments();
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar();
}

function goToToday() {
    currentDate = new Date();
    generateCalendar();
}

function openScheduleModal() {
    document.getElementById('scheduleModal').classList.add('show');
}

async function scheduleAppointment() {
    const formData = {
        client: document.getElementById('clientSelect').value,
        counselor: document.getElementById('counselorSelect').value,
        title: document.getElementById('appointmentTitle').value,
        scheduled_date: document.getElementById('appointmentDateTime').value,
        duration_minutes: parseInt(document.getElementById('appointmentDuration').value),
        description: document.getElementById('appointmentDescription').value
    };

    try {
        await apiCall('/api/admin/appointments/', {
            method: 'POST',
            body: JSON.stringify(formData)
        });

        closeModal();
        loadAppointments();
        loadStats();
        generateCalendar();
        alert('Appointment scheduled successfully');
    } catch (error) {
        console.error('Error scheduling appointment:', error);
        alert('Failed to schedule appointment. Please try again.');
    }
}

function viewAppointmentDetails(appointmentId) {
    // This would load and display appointment details in a modal
    alert('View appointment details functionality would be implemented here');
}

function editAppointment(appointmentId) {
    // This would open edit modal with pre-filled data
    alert('Edit appointment functionality would be implemented here');
}

async function cancelAppointment(appointmentId) {
    if (confirm('Are you sure you want to cancel this appointment?')) {
        try {
            await apiCall(`/api/admin/appointments/${appointmentId}/`, {
                method: 'PATCH',
                body: JSON.stringify({ status: 'cancelled' })
            });

            loadAppointments();
            loadStats();
            generateCalendar();
            alert('Appointment cancelled successfully');
        } catch (error) {
            console.error('Error cancelling appointment:', error);
            alert('Failed to cancel appointment. Please try again.');
        }
    }
}

function startAppointment(appointmentId) {
    // This would start the appointment (e.g., join video call)
    alert('Start appointment functionality would be implemented here');
}

function closeModal() {
    document.getElementById('scheduleModal').classList.remove('show');
    document.getElementById('detailsModal').classList.remove('show');
}

function showError(message) {
    const container = document.getElementById('appointmentsList');
    container.innerHTML = `<div style="text-align: center; padding: 3rem; color: #dc2626;">${message}</div>`;
}

function logout() {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    localStorage.removeItem('user');
    window.location.href = '/';
}

// Close modals when clicking outside
document.getElementById('scheduleModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('detailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}